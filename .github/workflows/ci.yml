name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  MIX_ENV: test
  ELIXIR_VERSION: '1.15'
  OTP_VERSION: '26'

jobs:
  documentation:
    name: Documentation Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check documentation coverage
        run: ./scripts/check-doc-coverage.sh

  elixir:
    name: Elixir
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: cordial_cantina_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    defaults:
      run:
        working-directory: cordial_cantina
    steps:
      - uses: actions/checkout@v4

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Set up Rust (for NIF)
        uses: dtolnay/rust-toolchain@stable

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            cordial_cantina/deps
            cordial_cantina/_build
            cordial_cantina/native/nif/target
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-mix-nif-${{ hashFiles('cordial_cantina/mix.lock', 'cordial_cantina/native/nif/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-mix-nif-

      - name: Install dependencies
        run: mix deps.get

      - name: Compile (including NIF)
        run: mix compile --force

      - name: Run precommit checks
        run: mix precommit

      - name: Run coverage report
        run: mix coveralls.json

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: cordial_cantina/cover/excoveralls.json
          fail_ci_if_error: false
        continue-on-error: true

  rust:
    name: Rust
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: joltshark
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            joltshark/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('joltshark/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Check formatting
        run: cargo fmt --check

      - name: Run clippy
        run: cargo clippy -- -D warnings

      - name: Run tests
        run: cargo test

      - name: Install cargo-tarpaulin
        run: |
          if ! command -v cargo-tarpaulin &> /dev/null; then
            cargo install cargo-tarpaulin --locked
          fi

      - name: Run coverage
        run: cargo tarpaulin --out Json --output-dir ./coverage
        continue-on-error: true

      - name: Upload Rust coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: joltshark/coverage/tarpaulin-report.json
          fail_ci_if_error: false
        continue-on-error: true
